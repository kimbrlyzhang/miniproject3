```{r}
library(mdsr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(RMySQL)
install.packages("ggpubr")
library(ggpubr)
db <- dbConnect_scidb(dbname = "imdb")
```

```{r}
sequels <- db %>% 
  dbGetQuery("select  t.id, t.title, t.production_year, mii.info AS ratings, lt.link, mv.movie_id, mv.linked_movie_id
from title t
inner join movie_link mv on mv.linked_movie_id = t.id
left join link_type lt on lt.id = mv.link_type_id 
left join movie_info_idx mii on mii.movie_id = t.id 
where 
t.kind_id = '1' 
		and mii.info_type_id = 101
		and lt.link like 'follow%' or 'rema%' or 'version%';")
sequels
```

```{r}
trseq <- sequels %>%
  select(title, ratings)
```

```{r}
genres <- db %>%
  dbGetQuery("select t.id , t.title, mi.info, t.production_year
from title t 
inner join imdb.movie_info mi on mi.movie_id = t.id
where info_type_id = '3' 
and t.kind_id = '1'")
```

```{r}
genreseq <- inner_join(sequels, genres, by = 'id')

head(genreseq)

gseq <- genreseq %>% 
  group_by(title.x) %>%
  mutate(countitle = count(title.x)) %>%
  mutate(rate = as.numeric(ratings)) %>%
  mutate(average = sum(rate)/countitle)
  
gseq
```





```{r}
seq <- sequels %>%
  group_by(title) %>%
  mutate(countitle = count(title)) %>%
  mutate(rate = as.numeric(ratings)) %>%
  arrange(desc(countitle))
seq
```

```{r}
scattertest <- seq %>%
  mutate(average = sum(rate)/countitle)

seq %>%
  arrange(countitle)
```

```{r}

gseq %>% 
    filter(info == "History") 

gseq2 <- gseq %>%
  filter(countitle < 8) %>%
  #filter(info == c("History", "Thriller", "Biography", "Drama", "Animation", "Comedy", "Family", "Short")) %>%
  mutate(kscore = countitle/rate) %>%
  mutate(kimdb = sum(rate)/countitle) %>%
  group_by(info, countitle) %>%
  mutate( nk = n(), avrgk = sum(kimdb)/nk) 

gseq2


  
```



```{r}
ggplot(gseq2, aes(x = info, y = avrgk)) + 
  geom_() +  
  facet_wrap(~countitle)
```

```{r}
ggplot(gseq, aes(x = average, y = countitle)) + geom_point() + facet_wrap(~info)

ggscatter(gseq, x = "average", y = "countitle", add = "reg.line", conf.int = TRUE, cor.coef = TRUE, cor.method = "pearson") + facet_wrap(~info)
```


